<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ducky's Brain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "ducky-bg": "#ffe",
              "ducky-text": "#800000",
              "ducky-border": "#d9bfb7",
              "ducky-msg": "#f0e0d6",
              "cleo-msg": "#d7ecdd",
              "system-msg": "#d6e0f0",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-ducky-bg font-sans">
    <div id="navbar"></div>

    <div class="mb-8 mx-auto px-4 md:p-0">
      <div id="chat-container" class="transition-all duration-300">
        <div
          id="chat-messages"
          class="border border-ducky-border rounded h-[calc(100vh-250px)] overflow-y-auto mb-4"
        ></div>
        <form id="chat-form" class="flex gap-2">
          <input
            type="text"
            id="user-input"
            class="flex-grow border border-ducky-border p-2"
            disabled
            placeholder="Chat will be generally available soon"
          />
          <button
            type="submit"
            class="bg-ducky-text text-white px-4 py-2 opacity-50"
            disabled
          >
            Send
          </button>
        </form>
      </div>
    </div>
    <script>
      const chatForm = document.getElementById("chat-form");
      const userInput = document.getElementById("user-input");
      const chatMessages = document.getElementById("chat-messages");
      const chatContainer = document.getElementById("chat-container");
      const CHARACTER_LIMIT = 500;

      // Avatar mapping
      const AVATARS = {
        ducky: "/static/avatars/ducky.jpg",
        cleo: "/static/avatars/ducky.jpg",
        user: "/static/avatars/ducky.jpg",
        error: "/static/avatars/ducky.jpg",
        system: "/static/avatars/ducky.jpg",
      };

      function createMessageHTML(
        speaker,
        content,
        shouldTruncate,
        displayContent,
        speakerStyle,
        timestamp = ""
      ) {
        return `
          <div class="flex gap-6 items-start pl-2">
            <div class="w-10 h-10 flex-shrink-0">
              <img src="${getAvatarUrl(
                speaker
              )}" alt="${speaker}" class="rounded-full w-full h-full object-cover">
            </div>
            <div class="min-w-0 max-w-6xlflex-1">
              <div class="rounded p-4 ${speakerStyle}">
                <div class="font-bold mb-2">${speaker}</div>
                <div class="pl-2">
                  <span class="message-content">${displayContent}</span>
                  ${
                    shouldTruncate
                      ? `
                    <button class="text-ducky-text hover:underline load-more">...</button>
                  `
                      : ""
                  }
                </div>
                ${
                  timestamp
                    ? `
                  <div class="text-xs text-ducky-text mt-2">${timestamp}</div>
                `
                    : ""
                }
              </div>
            </div>
          </div>
        `;
      }

      function getAvatarUrl(speaker) {
        const key = speaker.toLowerCase();
        return AVATARS[key] || AVATARS.user;
      }

      async function loadNavbar() {
        try {
          const response = await fetch("/static/navbar.html");
          const html = await response.text();
          document.getElementById("navbar").innerHTML = html;

          // Initialize timestamp after navbar is loaded
          function updateTimestamp() {
            const timestampElement = document.getElementById("timedatestamp");
            if (timestampElement) {
              const timedatestamp = new Date().toLocaleString();
              timestampElement.innerHTML = timedatestamp;
            }
          }

          // Update immediately and then every second
          updateTimestamp();
          setInterval(updateTimestamp, 1000);
        } catch (error) {
          console.error("Error loading navbar:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", loadNavbar);

      async function loadChatHistory() {
        try {
          const response = await fetch("/api/chat_history");
          const data = await response.json();

          chatMessages.innerHTML = "";

          data.messages.forEach((message) => {
            const messageDiv = document.createElement("div");
            messageDiv.className = "mb-6";

            const speakerStyle =
              message.speaker.toLowerCase() === "ducky"
                ? "text-ducky-text bg-ducky-msg"
                : message.speaker.toLowerCase() === "cleo"
                ? "text-ducky-text bg-cleo-msg"
                : "text-ducky-text bg-system-msg";

            const shouldTruncate = message.content.length > CHARACTER_LIMIT;
            const displayContent = shouldTruncate
              ? message.content.slice(0, CHARACTER_LIMIT)
              : message.content;

            messageDiv.innerHTML = createMessageHTML(
              message.speaker,
              message.content,
              shouldTruncate,
              displayContent,
              speakerStyle,
              new Date(message.timestamp).toLocaleString()
            );

            if (shouldTruncate) {
              const loadMoreBtn = messageDiv.querySelector(".load-more");
              let isExpanded = false;

              loadMoreBtn.addEventListener("click", () => {
                const contentDiv = messageDiv.querySelector(".message-content");
                if (isExpanded) {
                  contentDiv.textContent = message.content.slice(
                    0,
                    CHARACTER_LIMIT
                  );
                  loadMoreBtn.textContent = "...";
                } else {
                  contentDiv.textContent = message.content;
                  loadMoreBtn.textContent = " (show less)";
                }
                isExpanded = !isExpanded;
              });
            }

            chatMessages.appendChild(messageDiv);
          });

          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error("Error loading chat history:", error);
          addMessage("Error", "Failed to load chat history", true);
        }
      }

      function addMessage(speaker, content, isError = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "mb-6";

        const speakerStyle =
          speaker.toLowerCase() === "ducky"
            ? "text-ducky-text bg-ducky-msg"
            : speaker.toLowerCase() === "cleo"
            ? "text-ducky-text bg-cleo-msg"
            : isError
            ? "text-red-600 bg-red-50"
            : "text-blue-600 bg-blue-50";

        const shouldTruncate = content.length > CHARACTER_LIMIT;
        const displayContent = shouldTruncate
          ? content.slice(0, CHARACTER_LIMIT)
          : content;

        messageDiv.innerHTML = createMessageHTML(
          speaker,
          content,
          shouldTruncate,
          displayContent,
          speakerStyle
        );

        if (shouldTruncate) {
          const loadMoreBtn = messageDiv.querySelector(".load-more");
          let isExpanded = false;

          loadMoreBtn.addEventListener("click", () => {
            const contentDiv = messageDiv.querySelector(".message-content");
            if (isExpanded) {
              contentDiv.textContent = content.slice(0, CHARACTER_LIMIT);
              loadMoreBtn.textContent = "...";
            } else {
              contentDiv.textContent = content;
              loadMoreBtn.textContent = " (show less)";
            }
            isExpanded = !isExpanded;
          });
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateAssistantMessage(content, role = "Ducky") {
        let assistantMessageDiv = chatMessages.lastElementChild;
        const shouldTruncate = content.length > CHARACTER_LIMIT;
        const displayContent = shouldTruncate
          ? content.slice(0, CHARACTER_LIMIT)
          : content;

        if (
          !assistantMessageDiv ||
          assistantMessageDiv.querySelector(".font-bold").textContent !==
            `${role}`
        ) {
          assistantMessageDiv = document.createElement("div");
          assistantMessageDiv.className = "mb-6";
          const bgColor =
            role.toLowerCase() === "ducky"
              ? "bg-ducky-msg"
              : role.toLowerCase() === "cleo"
              ? "bg-cleo-msg"
              : "bg-system-msg";

          assistantMessageDiv.innerHTML = createMessageHTML(
            role,
            content,
            shouldTruncate,
            displayContent,
            `text-ducky-text ${bgColor}`
          );

          if (shouldTruncate) {
            const loadMoreBtn = assistantMessageDiv.querySelector(".load-more");
            let isExpanded = false;

            loadMoreBtn.addEventListener("click", () => {
              const contentDiv =
                assistantMessageDiv.querySelector(".message-content");
              if (isExpanded) {
                contentDiv.textContent = content.slice(0, CHARACTER_LIMIT);
                loadMoreBtn.textContent = "...";
              } else {
                contentDiv.textContent = content;
                loadMoreBtn.textContent = " (show less)";
              }
              isExpanded = !isExpanded;
            });
          }

          chatMessages.appendChild(assistantMessageDiv);
        } else {
          const contentDiv =
            assistantMessageDiv.querySelector(".message-content");
          contentDiv.textContent = displayContent;

          const existingBtn = assistantMessageDiv.querySelector(".load-more");
          if (shouldTruncate && !existingBtn) {
            const loadMoreBtn = document.createElement("button");
            loadMoreBtn.className = "text-ducky-text hover:underline load-more";
            loadMoreBtn.textContent = "...";

            let isExpanded = false;
            loadMoreBtn.addEventListener("click", () => {
              if (isExpanded) {
                contentDiv.textContent = content.slice(0, CHARACTER_LIMIT);
                loadMoreBtn.textContent = "...";
              } else {
                contentDiv.textContent = content;
                loadMoreBtn.textContent = " (show less)";
              }
              isExpanded = !isExpanded;
            });

            contentDiv.parentNode.insertBefore(
              loadMoreBtn,
              contentDiv.nextSibling
            );
          }
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateAssistantMessage(content, role = "Ducky") {
        let assistantMessageDiv = chatMessages.lastElementChild;
        const shouldTruncate = content.length > CHARACTER_LIMIT;
        const displayContent = shouldTruncate
          ? content.slice(0, CHARACTER_LIMIT)
          : content;

        if (
          !assistantMessageDiv ||
          assistantMessageDiv.querySelector(".font-bold").textContent !==
            `${role}:`
        ) {
          assistantMessageDiv = document.createElement("div");
          assistantMessageDiv.className = "mb-6 flex gap-3";
          const bgColor =
            role.toLowerCase() === "ducky"
              ? "bg-ducky-msg"
              : role.toLowerCase() === "cleo"
              ? "bg-cleo-msg"
              : "bg-system-msg";

          assistantMessageDiv.innerHTML = `
            <div class="avatar-container w-10 h-10">
              <img src="${getAvatarUrl(
                role
              )}" alt="${role}" class="rounded-full w-full h-full object-cover">
            </div>
            <div class="flex-grow">
              <div class="rounded p-3 ${bgColor}">
                <div class="font-bold text-ducky-text mb-1">${role}</div>
                <div class="pl-2">
                  <span class="message-content">${displayContent}</span>
                  ${
                    shouldTruncate
                      ? `
                    <button class="text-ducky-text hover:underline load-more">...</button>
                  `
                      : ""
                  }
                </div>
              </div>
            </div>
          `;

          if (shouldTruncate) {
            const loadMoreBtn = assistantMessageDiv.querySelector(".load-more");
            let isExpanded = false;

            loadMoreBtn.addEventListener("click", () => {
              const contentDiv =
                assistantMessageDiv.querySelector(".message-content");
              if (isExpanded) {
                contentDiv.textContent = content.slice(0, CHARACTER_LIMIT);
                loadMoreBtn.textContent = "...";
              } else {
                contentDiv.textContent = content;
                loadMoreBtn.textContent = " (show less)";
              }
              isExpanded = !isExpanded;
            });
          }

          chatMessages.appendChild(assistantMessageDiv);
        } else {
          const contentDiv =
            assistantMessageDiv.querySelector(".message-content");
          contentDiv.textContent = displayContent;

          const existingBtn = assistantMessageDiv.querySelector(".load-more");
          if (shouldTruncate && !existingBtn) {
            const loadMoreBtn = document.createElement("button");
            loadMoreBtn.className = "text-ducky-text hover:underline load-more";
            loadMoreBtn.textContent = "...";

            let isExpanded = false;
            loadMoreBtn.addEventListener("click", () => {
              if (isExpanded) {
                contentDiv.textContent = content.slice(0, CHARACTER_LIMIT);
                loadMoreBtn.textContent = "...";
              } else {
                contentDiv.textContent = content;
                loadMoreBtn.textContent = " (show less)";
              }
              isExpanded = !isExpanded;
            });

            contentDiv.parentNode.insertBefore(
              loadMoreBtn,
              contentDiv.nextSibling
            );
          }
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function streamResponse(message) {
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message }),
          });

          if (!response.ok) {
            let errorMessage;
            if (response.status === 429) {
              const errorData = await response.json();
              errorMessage =
                errorData.detail ||
                "Rate limit exceeded. Please try again later.";
            } else {
              errorMessage = `Error: ${response.status} ${response.statusText}`;
            }
            console.error("Error:", errorMessage);
            addMessage("Error", errorMessage, true);
            return;
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let assistantResponse = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const data = line.slice(6);
                if (data === "[DONE]") {
                  break;
                }
                try {
                  const parsed = JSON.parse(data);
                  assistantResponse += parsed.text;
                  updateAssistantMessage(assistantResponse, parsed.role);
                } catch (error) {
                  console.error("Error parsing SSE data:", error);
                  addMessage("Error", "Error parsing response data", true);
                }
              }
            }
          }
        } catch (error) {
          console.error("Error:", error);
          addMessage("Error", "An unexpected error occurred", true);
        }
      }

      function updateAssistantMessage(content, role = "Ducky") {
        let assistantMessageDiv = chatMessages.lastElementChild;
        const shouldTruncate = content.length > CHARACTER_LIMIT;
        const displayContent = shouldTruncate
          ? content.slice(0, CHARACTER_LIMIT) + "..."
          : content;

        if (
          !assistantMessageDiv ||
          assistantMessageDiv.querySelector(".font-bold").textContent !==
            `${role}:`
        ) {
          assistantMessageDiv = document.createElement("div");
          assistantMessageDiv.className = "mb-4";
          const bgColor =
            role.toLowerCase() === "ducky"
              ? "bg-ducky-msg"
              : role.toLowerCase() === "cleo"
              ? "bg-cleo-msg"
              : "bg-system-msg";

          assistantMessageDiv.innerHTML = `
            <div class="rounded p-3 ${bgColor}">
              <div class="font-bold text-ducky-text mb-1">${role}:</div>
              <div class="pl-2 message-content">${displayContent}</div>
              ${
                shouldTruncate
                  ? `
                <button class="text-sm text-ducky-text hover:underline mt-2 load-more">
                  Load More
                </button>
              `
                  : ""
              }
            </div>
          `;

          if (shouldTruncate) {
            const loadMoreBtn = assistantMessageDiv.querySelector(".load-more");
            let isExpanded = false;

            loadMoreBtn.addEventListener("click", () => {
              const contentDiv =
                assistantMessageDiv.querySelector(".message-content");
              if (isExpanded) {
                contentDiv.textContent =
                  content.slice(0, CHARACTER_LIMIT) + "...";
                loadMoreBtn.textContent = "Load More";
              } else {
                contentDiv.textContent = content;
                loadMoreBtn.textContent = "Show Less";
              }
              isExpanded = !isExpanded;
            });
          }

          chatMessages.appendChild(assistantMessageDiv);
        } else {
          const contentDiv =
            assistantMessageDiv.querySelector(".message-content");
          contentDiv.textContent = displayContent;

          const existingBtn = assistantMessageDiv.querySelector(".load-more");
          if (shouldTruncate && !existingBtn) {
            const loadMoreBtn = document.createElement("button");
            loadMoreBtn.className =
              "text-sm text-ducky-text hover:underline mt-2 load-more";
            loadMoreBtn.textContent = "Load More";

            let isExpanded = false;
            loadMoreBtn.addEventListener("click", () => {
              if (isExpanded) {
                contentDiv.textContent =
                  content.slice(0, CHARACTER_LIMIT) + "...";
                loadMoreBtn.textContent = "Load More";
              } else {
                contentDiv.textContent = content;
                loadMoreBtn.textContent = "Show Less";
              }
              isExpanded = !isExpanded;
            });

            assistantMessageDiv
              .querySelector(".rounded")
              .appendChild(loadMoreBtn);
          }
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function displayTweets(tweets) {
        const container = document.getElementById("tweets");
        const title = container.querySelector("h1");
        const countdown = container.querySelector("#serious_countdown");
        container.innerHTML = "";
        container.appendChild(title);
        container.appendChild(countdown);
        tweets.forEach((tweet) => {
          const div = document.createElement("div");
          div.className = "border border-ducky-border rounded p-3 mb-5";
          div.innerHTML = `
            <div class="text-sm text-ducky-text mb-2">Tweet: ${tweet.timestamp}</div>
            <div class="p-3 bg-ducky-msg rounded">
              <div class="font-bold text-ducky-text mb-2">@mrfatducky</div>
              <div>${tweet.content}</div>
            </div>
          `;
          container.appendChild(div);
        });
      }

      loadChatHistory();
    </script>
  </body>
</html>
